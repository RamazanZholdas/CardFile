----------------------------------------------------------------
# Principal Mapper Findings

Findings identified in AWS account 201804844653

Date and Time: 2023-04-17T15:27:36.042593+00:00

Findings identified using Principal Mapper (1.1.5) from NCC Group: https://github.com/nccgroup/PMapper

## IAM Principals Can Escalate Privileges

### Severity

High

### Impact

A lower-privilege IAM User or Role is able to gain administrative privileges. This could lead to the lower-privilege principal being used to compromise the account and its resources.

### Description

In AWS, IAM Principals such as IAM Users or IAM Roles have their permissions defined using IAM Policies. These policies describe different actions, resources, and conditions where the principal can make a given API call to a service.

Administrative principals can call any action with any resource, as in the AdministratorAccess AWS-managed policy. However, some permissions may allow another non-administrative principal to gain access to an administrative principal. This represents a privilege escalation risk.

The following principals could escalate privileges:

* role/AWS-CodePipeline-Service can escalate privileges by accessing the administrative principal role/BinTestAdminRole:
   * role/AWS-CodePipeline-Service can use the EC2 Auto Scaling service role and create a launch configuration to access role/BinTestAdminRole

* role/aws-elasticbeanstalk-service-role can escalate privileges by accessing the administrative principal role/BinTestAdminRole:
   * role/aws-elasticbeanstalk-service-role can use the EC2 Auto Scaling service role and create a launch configuration to access role/BinTestAdminRole

* role/AWS-QuickSetup-StackSet-Local-AdministrationRole can escalate privileges by accessing the administrative principal role/AWS-QuickSetup-StackSet-Local-ExecutionRole:
   * role/AWS-QuickSetup-StackSet-Local-AdministrationRole can access via sts:AssumeRole role/AWS-QuickSetup-StackSet-Local-ExecutionRole

* role/AWSCodePipelineServiceRole-us-east-1-pipeline-cf-main can escalate privileges by accessing the administrative principal role/BinTestAdminRole:
   * role/AWSCodePipelineServiceRole-us-east-1-pipeline-cf-main can use the EC2 Auto Scaling service role and create a launch configuration to access role/BinTestAdminRole

* role/AWSReservedSSO_AWSPowerUserAccess_5fd93c527024f3e8 can escalate privileges by accessing the administrative principal role/BinTestAdminRole:
   * role/AWSReservedSSO_AWSPowerUserAccess_5fd93c527024f3e8 can call ssm:SendCommand to access an EC2 instance with access to role/BinTestAdminRole

* role/AWSServiceRoleForAmazonSSM can escalate privileges by accessing the administrative principal role/BinTestAdminRole:
   * role/AWSServiceRoleForAmazonSSM can call ssm:SendCommand to access an EC2 instance with access to role/BinTestAdminRole

* role/AWSServiceRoleForAutoScaling can escalate privileges by accessing the administrative principal role/BinTestAdminRole:
   * role/AWSServiceRoleForAutoScaling can use EC2 to run an instance with an existing instance profile to access role/BinTestAdminRole

* role/AWSServiceRoleForEC2Spot can escalate privileges by accessing the administrative principal role/BinTestAdminRole:
   * role/AWSServiceRoleForEC2Spot can use EC2 to run an instance with an existing instance profile to access role/BinTestAdminRole

* role/AWSServiceRoleForSSO can escalate privileges by accessing the administrative principal role/AWSReservedSSO_AWSAdministratorAccess_1baebfeb9df44819:
   * role/AWSServiceRoleForSSO can update the trust document to access role/AWSReservedSSO_AWSAdministratorAccess_1baebfeb9df44819

* role/DataPipelineDefaultRole can escalate privileges by accessing the administrative principal role/BinTestAdminRole:
   * role/DataPipelineDefaultRole can use EC2 to run an instance with an existing instance profile to access role/BinTestAdminRole



### Recommendation

Review the IAM Policies that are applicable to the affected IAM User(s) or Role(s). Either reduce the permissions of the administrative principal(s), or reduce the permissions of the principal(s) that can access the administrative principals.


## IAM Users With Administrative Permissions But No MFA Device

### Severity

Medium

### Impact

If an attacker gains access to any of the noted sensitive IAM Users, there is no secondary layer of protection in place to prevent the AWS from being compromised.

### Description

In AWS, an IAM User can be assigned a device for Multi-Factor Authentication (MFA). When an IAM User is assigned an MFA device, they are required to provide an extra factor of authentication when logging in to the AWS Console. It is also possible to create IAM Policies that impose extra restrictions on the permissions of IAM Users depending on whether or not they have authenticated with MFA when using the AWS API. Any IAM User with administrative privileges should be configured to have an MFA device. 

The following IAM Users with administrative privileges do not have an MFA device configured:

* user/AlisherCLI
* user/RamazansIAMUser
* user/zoriana.kovacs

### Recommendation

Assign an MFA device to each of the noted IAM Users.


## Administrative IAM User Can Call Sensitive Actions Without MFA

### Severity

Medium

### Impact

An adminstrative IAM User is able to call sensitive actions, such as creating more principals or modifying permissions, without using MFA.

### Description

In AWS, IAM Users can be configured to use an MFA device. When an IAM User has MFA enabled, they are required to provide the second factor of authentication when they log in to the AWS Console. However, unless there is a specific IAM policy attached to the user, they will not need to provide a second factor of authentication when making API calls.

The following administrative IAM Users have at least one set of access keys, and can call sensitive actions to alter permissions or add users without using a second factor of authentication:

* user/zoriana.kovacs


### Recommendation

Implement and attach an IAM Policy to the noted user(s) that rejects requests when MFA is not used.


## Instance Profile Has Administrator Privileges

### Severity

High

### Impact

If an instance with the noted instance profile(s) is compromised, then the AWS account as a whole is at risk of compromise.

### Description

In AWS, EC2 instances can be given an instance profile. These instance profiles are associated with an IAM Role, and grants access to the permissions of the IAM Role. Because EC2 instances are at a higher risk of exposure and compromise, both to external attackers and authorized users in the AWS account, they should not have access to administrative privileges. The following IAM Roles have administrative permissions and are associated with an instance profile:

* role/BinTestAdminRole


### Recommendation

Reduce the scope of permissions attached to the noted instance profile(s).


## IAM Roles Available to CloudFormation Stacks Have Administrative Privileges

### Severity

Low

### Impact

If an attacker has the right permissions in the AWS Account, they can grant themselves adminstrative access to the account to compromise the account.

### Description

In AWS, CloudFormation stacks can be given an IAM Role. When a stack has an IAM Role, it can use that IAM Role to make AWS API calls to create the resources defined in the template for that stack. If the IAM Role has administrator access to the account, and an attacker is able to make the right CloudFormation API calls, they would be able to use the IAM Role to escalate privileges and compromise the account as a whole. The following IAM Roles can be used in CloudFormation and have administrative privileges:

* role/Alisher-full
* role/cfn-training-role


### Recommendation

Reduce the scope of permissions attached to the noted IAM Role(s).


## IAM Role With Unsafe SSM Permissions

### Severity

Medium

### Impact

If an attacker gains access to an instance with the unsafe permissions, they could escalate privileges on its current host or compromise other hosts.

### Description

In AWS EC2, instances can be assigned instance profiles. An instance profile is tied to a single IAM Role. The instance profile can be used to access the AWS API with the permissions of the IAM Role. If the IAM Role has permission to call certain SSM actions such as `ssm:SendCommand` or `ssm:StartSession`, the instance profile can be used to invoke commands on other instances or itself.

Because the SSM Agent runs with the highest permissions on their hosts (root or SYSTEM), this can be a way for attackers to pivot and compromise other instances, or escalate privileges on the local machine. The following IAM Roles are attached to at least one instance profile and have permissions with the aforementioned risk:

* role/BinTestAdminRole


### Recommendation

Reduce the scope of permissions attached to the noted IAM Role(s).


## IAM Principals with Circular Access

### Severity

Low

### Impact

If an attacker gains access to one of the identified principals, they can potentially evade detections or persist access.

### Description

In AWS, an IAM Principal with a specific set of permissions can gain access to another principal, such as when an IAM User has permission to call `sts:AssumeRole` for an IAM Role. Principal Mapper tracks these connections as Nodes (a.k.a. Vertices) and Edges in a Graph.

However, there may be instances where nodes can access each other in a circular manner. This presents a risk in the account if an attacker gains access to one of the principals in a cycle. An attacker can abuse that access to pivot between each of the principals in a cycle. This can be used to evade detection or persist access to an AWS account. The following cycles were identified:

* role/AWS-QuickSetup-StackSet-Local-AdministrationRole -> role/AWS-QuickSetup-StackSet-Local-ExecutionRole -> role/AWS-QuickSetup-StackSet-Local-AdministrationRole
* role/AWSServiceRoleForSSO -> role/AWSReservedSSO_AWSAdministratorAccess_1baebfeb9df44819 -> role/AWSServiceRoleForSSO


### Recommendation

Break the cycle of access by altering/removing permissions assigned to one of the noted principals.



----------------------------------------------------------------
